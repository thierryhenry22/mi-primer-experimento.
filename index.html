<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Henry AI | Master Interface (Streaming)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* (Mantén aquí tu CSS actual; por brevedad lo omitimos en este bloque) */
    /* ... copia el CSS que ya tienes en tu index actualizado ... */
    :root{ --accent:#4285f4; }
    /* styles mínimos para demo */
    body{ font-family:Inter,system-ui; background:#0f1114; color:#e7eef8; display:flex; align-items:center; justify-content:center; min-height:100vh; }
    .gemini-container{ width:90%; max-width:720px; padding:24px; border-radius:20px; background:rgba(255,255,255,0.03); }
    #ai-response{ min-height:3.2rem; font-weight:600; margin-bottom:12px; }
    .input-group{ display:flex; gap:12px; }
    .input{ flex:1; padding:10px; border-radius:10px; border:none; background:transparent; color:inherit; outline: none; }
    .btn-execute{ background:linear-gradient(90deg,var(--accent),#9b72cb); color:white; padding:10px 16px; border-radius:10px; border:none; cursor:pointer; }
  </style>
</head>
<body>
  <main class="gemini-container" role="main">
    <h1>Henry AI (Streaming)</h1>
    <div id="ai-response" aria-live="polite" aria-atomic="true">Sistemas listos. ¿Qué deseas consultar?</div>

    <div class="input-group">
      <input id="user-input" class="input" type="text" placeholder="Escribe un comando o color..." onkeypress="handleEnter(event)" />
      <button id="exec" class="btn-execute" onclick="streamProcesarIA()">Ejecutar Protocolo</button>
    </div>
  </main>

  <script>
    const inputEl = document.getElementById('user-input');
    const aiResponse = document.getElementById('ai-response');
    const execBtn = document.getElementById('exec');

    function handleEnter(e){
      if(e.key === 'Enter') streamProcesarIA();
    }

    // función que consume el stream desde /api/chat y lo muestra en tiempo real:
    async function streamProcesarIA(){
      const message = inputEl.value?.trim();
      if(!message) return;
      // estado UI
      execBtn.disabled = true;
      execBtn.textContent = 'Conectando...';
      aiResponse.textContent = ''; // limpiamos la respuesta anterior

      try {
        const resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        if(!resp.ok) {
          const err = await resp.text();
          aiResponse.textContent = 'Error: ' + err;
          return;
        }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let done = false;
        let accumulated = '';

        execBtn.textContent = 'Conectado · Recibiendo...';

        while(!done){
          const { value, done: readerDone } = await reader.read();
          if(readerDone) {
            done = true;
            break;
          }
          const chunk = decoder.decode(value, { stream: true });
          // appendamos el chunk tal cual (el servidor envía tokens parciales)
          accumulated += chunk;
          aiResponse.textContent = accumulated;
          // opcional: scroll, caret visual, etc.
        }

        // final:
        execBtn.textContent = 'Ejecutar Protocolo';
        inputEl.value = '';
        inputEl.focus();

      } catch (err) {
        console.error('Streaming error', err);
        aiResponse.textContent = 'Error de conexión. Revisa la consola.';
        execBtn.textContent = 'Ejecutar Protocolo';
      } finally {
        execBtn.disabled = false;
      }
    }

    // foco en carga
    window.addEventListener('load', ()=> setTimeout(()=> inputEl.focus(),300));
  </script>
</body>
</html>
