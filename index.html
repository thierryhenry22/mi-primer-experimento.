<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Voxel Engine Pro - Life & Nature</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; }
        #ui { position: absolute; bottom: 20px; left: 20px; color: white; font-family: 'Courier New', monospace; text-shadow: 2px 2px black; }
    </style>
</head>
<body>
    <div id="ui">VELOCIDAD: TURBO | ENTIDADES: ACTIVAS</div>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x4488ff);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const controls = new PointerLockControls(camera, document.body);
        document.body.addEventListener('click', () => controls.lock());

        // --- MATERIALES Y GEOMETRÍA ---
        const geoBlock = new THREE.BoxGeometry(0.995, 0.995, 0.995); // Separación sutil corregida
        const matGrass = new THREE.MeshStandardMaterial({ color: 0x559944 });
        const matWool = new THREE.MeshStandardMaterial({ color: 0xffffff });
        const entities = [];

        // --- GENERADOR DE FLORES DETALLADAS ---
        function createFlower(x, y, z, type) {
            const group = new THREE.Group();
            const stemGeo = new THREE.BoxGeometry(0.1, 0.6, 0.1);
            const stem = new THREE.Mesh(stemGeo, new THREE.MeshStandardMaterial({color: 0x225522}));
            group.add(stem);

            const petalColor = type === 'rose' ? 0xff0000 : 0xffff00;
            const petalGeo = new THREE.BoxGeometry(0.3, 0.1, 0.3);
            for(let i=0; i<4; i++) {
                const p = new THREE.Mesh(petalGeo, new THREE.MeshStandardMaterial({color: petalColor}));
                p.position.y = 0.3;
                p.rotation.y = (Math.PI / 2) * i;
                group.add(p);
            }
            group.position.set(x, y + 0.3, z);
            scene.add(group);
        }

        // --- SISTEMA DE ANIMALES (OVEJAS) ---
        function spawnAnimal(x, y, z) {
            const body = new THREE.Group();
            const torso = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.6, 1), matWool);
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), matWool);
            head.position.set(0, 0.3, 0.6);
            body.add(torso, head);
            body.position.set(x, y + 1, z);
            body.userData = { 
                targetX: x, targetZ: z, 
                timer: 0, 
                speed: 0.02 + Math.random() * 0.03 
            };
            scene.add(body);
            entities.push(body);
        }

        // --- TERRENO ---
        const getH = (x, z) => Math.floor(Math.sin(x*0.1)*3 + Math.cos(z*0.1)*2 + 5);
        for(let x=-20; x<20; x++) {
            for(let z=-20; z<20; z++) {
                const y = getH(x, z);
                const b = new THREE.Mesh(geoBlock, matGrass);
                b.position.set(x, y, z);
                scene.add(b);
                if(Math.random() < 0.03) createFlower(x, y+0.5, z, Math.random() > 0.5 ? 'rose' : 'daisy');
                if(Math.random() < 0.01) spawnAnimal(x, y, z);
            }
        }

        // --- SOL ---
        const sun = new THREE.DirectionalLight(0xffffff, 1.5);
        sun.position.set(50, 100, 50);
        scene.add(sun, new THREE.AmbientLight(0xffffff, 0.4));

        // --- FÍSICA ---
        let velY = 0;
        let canJump = false;
        const keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        camera.position.set(0, 15, 0);

        function updateAI() {
            entities.forEach(anim => {
                anim.userData.timer--;
                if(anim.userData.timer <= 0) {
                    anim.userData.targetX = anim.position.x + (Math.random() - 0.5) * 10;
                    anim.userData.targetZ = anim.position.z + (Math.random() - 0.5) * 10;
                    anim.userData.timer = 100 + Math.random() * 200;
                }
                anim.position.x += (anim.userData.targetX - anim.position.x) * 0.01;
                anim.position.z += (anim.userData.targetZ - anim.position.z) * 0.01;
                anim.lookAt(anim.userData.targetX, anim.position.y, anim.userData.targetZ);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            if(controls.isLocked) {
                const s = 0.2; // VELOCIDAD PRO
                if(keys['KeyW']) controls.moveForward(s);
                if(keys['KeyS']) controls.moveForward(-s);
                if(keys['KeyA']) controls.moveRight(-s);
                if(keys['KeyD']) controls.moveRight(s);
                if(keys['Space'] && canJump) { velY = 0.25; canJump = false; }

                velY -= 0.01;
                camera.position.y += velY;
                const ground = getH(Math.round(camera.position.x), Math.round(camera.position.z)) + 1.8;
                if(camera.position.y < ground) {
                    camera.position.y = ground;
                    velY = 0;
                    canJump = true;
                }
                updateAI();
            }
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
